---
title: "BR2211 Cancer Incidence Rate Prediction"
output: github_document
---

## Part (a) Data Cleaning & Identifying Key Cancers for both Males & Females

### 1. Import dataset and necessary packages

make sure working directory is the BR2211 Cancer Incidence Data Folder

```{r}
rm(list=ls())

# List of required packages
required_packages <- c("readxl", "tidyverse","torch", "luz" ,"tseries","forecast")

# Check if the required packages are installed
missing_packages <- required_packages[!requireNamespace(required_packages, quietly = TRUE)]

# Install missing packages if any
if (length(missing_packages) > 0) {
  install.packages(missing_packages)
}

library('readxl')
library('tidyverse')
library('forecast')
library('tseries')
library('torch')
library('luz')
```

```{r}
#Read excel
Cancer_Incidence <-read_excel("Cancer Incidence Data.xlsx")
#Rename Columns
names(Cancer_Incidence) [1] <- "Data type"
names(Cancer_Incidence) [2] <- "Cancer group/site"
names(Cancer_Incidence) [3] <- "Year"
names(Cancer_Incidence) [4] <- "Sex"
names(Cancer_Incidence) [5] <- "Age group (years)"
names(Cancer_Incidence) [6] <- "Count"
names(Cancer_Incidence) [7] <- "Age-specific rate (per 100,000)"
names(Cancer_Incidence) [8] <- "Age-standardised rate + 2001 Australian Standard Population (per 100,000)"
names(Cancer_Incidence) [9] <- "Age-standardised rate + 2023 Australian Population"
names(Cancer_Incidence) [10] <- "Age-standardised rate (WHO) (per 100,000)"
names(Cancer_Incidence) [11] <- "Age-standardised rate (Segi) (per 100,000)"
names(Cancer_Incidence) [13] <- "ICD 10 codes"

```

### 2. Data Cleaning

#### 2.1 Remove irrelevant information

The following operations are conducted:

-   Remove Rows 1 to 4 with NA values

-   Remove Column 12 with NA values

-   Convert data class of Year to numeric

-   Remove all years before Year 2001 for simplicity

-   Remove all projections

-   Combine all age groups: Remove all age group except for ages combined

```{r}
Cancer_Incidence2 <- Cancer_Incidence %>%
  slice(5:n()) %>%
  select(-"...12") %>%
  mutate(Year = as.numeric(as.character(Year))) %>%
  filter(Year > 2000) %>%
  filter(!str_detect(`Data type`, "Projections")) %>%
  filter(`Age group (years)` == "All ages combined")
```

#### 2.2 Get gender/non-gender specific cancer incidence rates

```{r}
#Remove all sex groups and keep only males
Cancer_IncidenceMales <-Cancer_Incidence2%>%filter(`Sex`=='Males')%>%mutate(`Age-standardised rate (WHO) (per 100,000)`=as.numeric(as.character(`Age-standardised rate (WHO) (per 100,000)`)))
glimpse(Cancer_IncidenceMales)
```

```{r}
#Remove all sex groups and keep only females
Cancer_IncidenceFemales <-Cancer_Incidence2%>%filter(`Sex`=='Females')%>%mutate(`Age-standardised rate (WHO) (per 100,000)`=as.numeric(as.character(`Age-standardised rate (WHO) (per 100,000)`)))
glimpse(Cancer_IncidenceFemales)
```

```{r}
#Remove all sex groups and keep only persons
Cancer_IncidenceAll <-Cancer_Incidence2%>%filter(`Sex`=='Persons')%>%mutate(`Age-standardised rate (WHO) (per 100,000)`=as.numeric(as.character(`Age-standardised rate (WHO) (per 100,000)`)))
glimpse(Cancer_IncidenceAll)
```

#### 2.3 Identify Key Cancers

Identify Key Cancers for Males

```{r}
# Sum up the Age-standardised rate (WHO) (per 100,000) by types of cancer for males
Cancer_sumagestdMales <- Cancer_IncidenceMales %>%
  group_by(`Cancer group/site`) %>%
  summarise(sum = sum(`Age-standardised rate (WHO) (per 100,000)`)) %>%
  arrange(desc(sum))

head(Cancer_sumagestdMales,n=10)
```

```{r}
ggplot(head(Cancer_sumagestdMales, 10), aes(x = reorder(`Cancer group/site`, -sum), y = sum)) +
  geom_bar(stat = "identity", fill = "skyblue") +
  labs(title = "Top 10 Cancers for Males",
       x = "Cancer Group/Site",
       y = "Sum of ASR from 2001-2019") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

```

Identify Key Cancers for Females

```{r}
# Sum up the Age-standardised rate (WHO) (per 100,000) by types of cancer for females
Cancer_sumagestdFemales <- Cancer_IncidenceFemales %>%
  group_by(`Cancer group/site`) %>%
  summarise(sum = sum(`Age-standardised rate (WHO) (per 100,000)`)) %>%
  arrange(desc(sum))

head(Cancer_sumagestdFemales,n=10)
```

```{r}
ggplot(head(Cancer_sumagestdFemales, 10), aes(x = reorder(`Cancer group/site`, -sum), y = sum)) +
  geom_bar(stat = "identity", fill = "lightpink") +
  labs(title = "Top 10 Cancers for Females",
       x = "Cancer Group/Site",
       y = "Sum of ASR from 2001-2019") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

```

Identify Key Cancers for all Australians from 2001-2019

```{r}
# Sum up the Age-standardised rate (WHO) (per 100,000) by types of cancer for persons
Cancer_sumagestdAll <- Cancer_IncidenceAll %>%
  group_by(`Cancer group/site`) %>%
  summarise(sum = sum(`Age-standardised rate (WHO) (per 100,000)`)) %>%
  arrange(desc(sum))
head(Cancer_sumagestdAll,n=10)
```

```{r}
ggplot(head(Cancer_sumagestdAll, 10), aes(x = reorder(`Cancer group/site`, -sum), y = sum)) +
  geom_bar(stat = "identity", fill = "lightgreen") +
  labs(title = "Top 10 Cancers for All Persons",
       x = "Cancer Group/Site",
       y = "Sum of ASR from 2001-2019") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

```

## Part (b) Risk Factors

### 1. Non-gender specific cancers

#### 1.1 Colorectal cancer

```{r}
###All Colorectal Cancer
# Load data for Colorectal Cancer
colorectal_data <- read_excel("RiskFactors.xlsx", sheet = "ColorectalCancer")

# Summarize the data for Colorectal Cancer
summary(colorectal_data)

```

```{r}
# Model the relationship for Colorectal Cancer
colorectal_model <- lm(ColorectalCancer ~ Inflammatory_bowel_disease + Tobacoo + Alcohol_use + Drug_use + High_bodymass_index + High_systolic_blood_pressure + High_LDL_cholesterol, data = colorectal_data)

# Summarize the regression model
summary(colorectal_model)

```

```{r}

# Perform stepwise regression using AIC
colorectal_stepwise_model <- MASS::stepAIC(colorectal_model, direction = "both")

# Summarize the stepwise regression model
summary(colorectal_stepwise_model)

```

```{r}
######## Try run in terminals! ########

# Plot diagnostic plots for the final linear model
par(mfrow = c(2, 2))
plot(colorectal_stepwise_model)

```

#### 1.1 Melanoma cancer

```{r}
###All Melanoma of the skin 
# Load data for Melanoma of the skin
melanoma_data <- read_excel("RiskFactors.xlsx", sheet = "MekanomaCancer")

# Summarize the data for Melanoma of the skin
summary(melanoma_data)
```

```{r}
# Model the relationship for Melanoma of the skin
melanoma_model <- lm(MekanomaCancer ~ High_temperature, data = melanoma_data)

# Summarize the regression model
summary(melanoma_model)

```

```{r}
# Perform stepwise regression using AIC
melanoma_stepwise_model <- MASS::stepAIC(melanoma_model, direction = "both")

# Summarize the stepwise regression model
summary(melanoma_stepwise_model)
```

```{r}
# Plot diagnostic plots for the final linear model
par(mfrow = c(2, 2))
plot(melanoma_stepwise_model)

```

### 2. Male cancers (prostate)

```{r}
# Load data for Male Prostate Cancer
prostate_data <- read_excel("RiskFactors.xlsx", sheet = "ProstateCancer")

# Summarize the data for Male Prostate Cancer
summary(prostate_data)
```

```{r}
# Model the relationship for Male Prostate Cancer
prostate_model <- lm(ProstateCancer ~ Ethnicity_SouthAfrica + Tobacoo + Alcohol_use + Drug_use + High_bodymass_index, data = prostate_data)

# Summarize the regression model
summary(prostate_model)

```

```{r}
# Perform stepwise regression using AIC
prostate_stepwise_model <- MASS::stepAIC(prostate_model, direction = "both")

# Summarize the stepwise regression model
summary(prostate_stepwise_model)
```

```{r}
# Plot diagnostic plots for the final linear model
par(mfrow = c(2, 2))
plot(prostate_stepwise_model)
```

``` r
```

### 

### 3. Female cancers (breast)

```{r}
# Load data for Female Breast Cancer
breast_data <- read_excel("RiskFactors.xlsx", sheet = "BreastCancer")

# Summarize the data for Female Breast Cancer
summary(breast_data)
```

```{r}
# Model the relationship for Female Breast Cancer
breast_model <- lm(BreastCancer ~ Low_physical_activity + Tobacoo + Alcohol_use + Drug_use + High_bodymass_index, data = breast_data)

# Summarize the regression model
summary(breast_model)
```

```{r}
# Perform stepwise regression using AIC
breast_stepwise_model <- MASS::stepAIC(breast_model, direction = "both")

# Summarize the stepwise regression model
summary(breast_stepwise_model)

```

```{r}
# Plot diagnostic plots for the final linear model
par(mfrow = c(2, 2))
plot(breast_stepwise_model)
```

```{r}
# Check for multicollinearity using VIF
breast_vif_values <- car::vif(breast_stepwise_model)
breast_vif_values

# Check correlation
cor(breast_data$Low_physical_activity, breast_data$High_bodymass_index)
cor(breast_data$Low_physical_activity, breast_data$Alcohol_use)

```

## Part (c) Time Series Analysis

### 1. Female Breast Cancer

#### 1.1 Data Cleaning & Exploratory

```{r}
Cancer_fem_brecancer1 <-read_excel("FemBreast.xlsx")
head(Cancer_fem_brecancer1,19)
```

```{r}
Cancer_fem_brecancer1 <- Cancer_fem_brecancer1 %>%
  select(Year, `Age-standardised rate (WHO) (per 100,000)`, `Overweight and Obese rate`) %>%
  mutate(`Age-standardised rate (WHO) (per 100,000)` = as.numeric(`Age-standardised rate (WHO) (per 100,000)`))

glimpse(Cancer_fem_brecancer1)
```

```{r}
ggplot(Cancer_fem_brecancer1, aes(x = Year, y = `Age-standardised rate (WHO) (per 100,000)`)) +
  geom_line() +
  labs(title = "Time Series Plot of Female Breast Cancer ASR",
       x = "Year",
       y = "Age-Standardized Rate (WHO) per 100,000") +
  theme_minimal()
```

#### 1.2 Model Selection/Training

##### 1.2.1 LSTM

###### 1.2.1.1 Data preprocessing and train-test split

```{r}
# Standardization (z-score normalization) to converge faster
Cancer_fem_brecancer1$ASR_scaled <- scale(Cancer_fem_brecancer1$`Age-standardised rate (WHO) (per 100,000)`)

original_mu = mean(Cancer_fem_brecancer1$`Age-standardised rate (WHO) (per 100,000)`)
original_sd =sd(Cancer_fem_brecancer1$`Age-standardised rate (WHO) (per 100,000)`)
```

```{r}
#hyperparams
#window_size '*' windown_size < 19 !!!!!(2001-2019)
window_size <- 12

#batch_size '*' 2,4,8,16
batch_size <- 4

#hidden_size '*' 
hidden_size <- 64
```

```{r}
# Following the convention, we adopt a 7:3 train test split 
# Define the proportion of data to use for training
train_frac <- 0.7

# Calculate the index to split the data
split_index <- floor(train_frac * (nrow(Cancer_fem_brecancer1)-window_size))+window_size

# Split the data into training and testing sets
train_data <- Cancer_fem_brecancer1[1:split_index, ]
test_data <- Cancer_fem_brecancer1[(split_index + 1):nrow(Cancer_fem_brecancer1), ]

train_data <- train_data$ASR_scaled%>% as.matrix()
test_data <- test_data$ASR_scaled%>% as.matrix()
scaled_data<- Cancer_fem_brecancer1$ASR_scaled%>%as.matrix()
```

###### 1.2.1.2 Define datasets and dataloaders

```{r}
# Define the dataset
cancer_ts_dataset <- dataset(
  name = "my_dataset",
  
  initialize = function(data, window_size, sample_frac = 1) {
    self$window_size <- window_size
    self$data <- torch_tensor(data)
    
    n <- length(self$data) - self$window_size
    
    self$starts <- sort(sample.int(
      n = n,
      size = n * sample_frac
    ))
  },
  
  .getitem = function(i) {
    start <- self$starts[i]
    end <- start + self$window_size - 1
    
    list(
      x = self$data[start:end],
      y = self$data[end + 1]
    )
  },
  
  .length = function() {
    length(self$starts)
  }
)

cancer_ts_eval_dataset <- dataset(
  name = "my_eval_dataset",
  
  initialize = function(data, window_size, sample_frac = 1) {
    self$window_size <- window_size
    self$data <- torch_tensor(data)
    
    n <- 1
    
    self$starts <- sort(sample.int(
      n = n,
      size = n * sample_frac
    ))
  },
  
  .getitem = function(i) {
    start <- self$starts[i]
    end <- start + self$window_size - 1
    
    list(
      x = self$data[start:end],
      y = self$data[start]
    )
  },
  
  .length = function() {
    length(self$starts)
  }
)


train_dataset <- cancer_ts_dataset(train_data, window_size = window_size, sample_frac = 1)


# Define the dataloader
train_dl <- train_dataset %>% dataloader(batch_size = batch_size, shuffle = TRUE)

# Check the shape
#length(train_dl)
#b <- train_dl %>% dataloader_make_iter() %>% dataloader_next()
#b

```

###### 1.2.1.3 Construct LSTM network

```{r}
# Define the TimeSeriesPredictor class
TimeSeriesPredictor <- nn_module(
  initialize = function(input_dim = 1, hidden_dim = 200, output_dim = 1, num_layers = 1, dropout = 0.2, rec_dropout = 0) {
    self$num_layers <- num_layers
    
    self$lstm <- nn_lstm(
      input_size = input_dim,
      hidden_size = hidden_dim,
      num_layers = num_layers,
      dropout = rec_dropout,
      batch_first = TRUE
    )
    
    self$dropout <- nn_dropout(dropout)
    self$fc1 <- nn_linear(hidden_dim, 100)
    self$fc2 <- nn_linear(100, output_dim)
  },
  forward = function(x) {
    (x %>%
       self$lstm())[[1]][, dim(x)[2], ] %>%
      #self$dropout() %>%
      self$fc1() %>%
      torch_relu() %>%
      self$fc2()
  }
)

```

###### 1.2.1.4 Training

```{r}
torch_manual_seed(123)

net <- TimeSeriesPredictor %>%
  setup(optimizer = optim_adam, loss = nn_mse_loss())%>%
  set_hparams(
    input_dim = 1,
    hidden_dim = hidden_size,
    rec_dropout = 0
  )


# Use learning rate finder
rates_and_losses <- net %>% 
  lr_finder(train_dl, start_lr = 1e-3, end_lr = 1)

# Plot the results
rates_and_losses %>% plot()

# It seems that lr =0.01 is a good choice

# Define the number of epochs '*'
epochs <- 100

# Fit the model
fitted <- net %>%
  set_opt_hparams(lr = 0.01) %>%
  fit(train_dl, 
      epochs = epochs, 
      verbose = TRUE)

# Plot the training progress
plot(fitted)
```

###### 1.2.1.5 Evaluation

```{r}
test_data_hat <- c()
for (x in 1:length(test_data)){
  if (x==1){
    test_dataset <- cancer_ts_eval_dataset((Cancer_fem_brecancer1[(length(train_data)-window_size+1):length(train_data),]$ASR_scaled%>%as.matrix()),window_size,1)  
  } else{
    test_dataset <- cancer_ts_eval_dataset(rbind(Cancer_fem_brecancer1[(length(train_data)-window_size+x):length(train_data),]$ASR_scaled%>%as.matrix(),matrix(test_data_hat[1:(x-1)],ncol = 1)),window_size,1)  
  }
  
  test_dl<-test_dataset%>%dataloader(batch_size = 1)
  test_data_hat<-rbind(test_data_hat,as_array(fitted%>%predict(test_dl))[1])
  
  #print(test_dataset[1])
  #cat("test_data_hat:",test_data_hat,"\n")
}

cat("Test loss: ",as_array(nn_mse_loss()
    ((torch_tensor(test_data_hat)),(torch_tensor(test_data)))))

```

```{r}
#HYPERPARAM TUNING (OPTIONAL)
#(DO NOT RUN IT UNLESS YOU ARE BORED!!!)

#  Define the grid of hyperparameters
# batch_sizes <- c(2,4,8)
# window_sizes<- c(4,8,12)
# hidden_sizes <- c(64,128,256)
# 
# # # Initialize variables to store the best hyperparameters and lowest test error
# best_params <- NULL
# lowest_test_error <- Inf
# iterator <-1
# # # Perform grid search
# for (batch_size in batch_sizes) {
#   for (window_size in window_sizes) {
#     for (hidden_size in hidden_sizes) {
#       # Train model with current hyperparameters
#       torch_manual_seed(123)
# 
#       split_index <- floor(train_frac * (nrow(Cancer_fem_brecancer1)-window_size))+window_size
#       train_data <- Cancer_fem_brecancer1[1:split_index, ]
#       test_data <- Cancer_fem_brecancer1[(split_index + 1):nrow(Cancer_fem_brecancer1), ]
#       train_data <- train_data$ASR_scaled%>% as.matrix()
#       test_data <- test_data$ASR_scaled%>% as.matrix()
# 
#       train_dataset<-cancer_ts_dataset(train_data,window_size,1)
#       train_dl<-train_dataset%>%dataloader(batch_size = batch_size,shuffle = TRUE)
# 
# 
#       net <- TimeSeriesPredictor %>%
#         setup(optimizer = optim_adam, loss = nn_mse_loss())%>%
#         set_hparams(
#           input_dim = 1,
#           hidden_dim = hidden_size,
#           rec_dropout = 0
#         )
# 
#       fitted <- net %>%
#         set_opt_hparams(lr = 0.01) %>%
#         fit(train_dl,
#             epochs = epochs,
#             verbose = FALSE)
# 
# 
# 
# 
#       # Evaluate model on test data
#       test_data_hat <- c()
#       for (x in 1:length(test_data)){
#         if (x==1){
#           test_dataset <- cancer_ts_eval_dataset((Cancer_fem_brecancer1[(length(train_data)-window_size+1):length(train_data),]$ASR_scaled%>%as.matrix()),window_size,1)
#         } else if(x<=window_size){
#           test_dataset <- cancer_ts_eval_dataset(rbind(Cancer_fem_brecancer1[(length(train_data)-window_size+x):length(train_data),]$ASR_scaled%>%as.matrix(),matrix(test_data_hat[1:(x-1)],ncol=1)),window_size,1)
#         }
#         else{
#           test_dataset <-cancer_ts_eval_dataset(matrix(tail(test_data_hat,n=window_size),ncol=1),window_size,1)
#         }
# 
#         test_dl<-test_dataset%>%dataloader(batch_size = 1)
#         test_data_hat<-rbind(test_data_hat,as_array(fitted%>%predict(test_dl))[1])
#       }
# 
#       test_error<-as_array(nn_mse_loss()
#                            ((torch_tensor(test_data_hat)),(torch_tensor(test_data))))[1]
# 
# 
#       # Check if current model has lowest test error
#       if (test_error < lowest_test_error) {
#         lowest_test_error <- test_error
#         best_params <- list(batch_size = batch_size,
#                             window_size = window_size,
#                             hidden_size = hidden_size)
#       }
#       cat("iteration:",iterator,"\n")
#       iterator<-iterator+1
#     }
#   }
# }
# 
# # # Print the best hyperparameters and lowest test error 
# print("Best Hyperparameters:")
# print(best_params) 
# print(paste("Lowest Test Error:",
# lowest_test_error))
# 

```

###### 1.2.1.6 Visualization of prediction on test set and next 20 years

```{r}
# Plot using ggplot2
predicted_df <- data.frame(Year = tail(Cancer_fem_brecancer1$Year,length(test_data_hat)), ASR_WHO = test_data_hat*original_sd+original_mu)


period<-20
predict_20 <- c()
for (x in 1:period){
  if (x==1){
    test_dataset <- cancer_ts_eval_dataset((Cancer_fem_brecancer1[(nrow(Cancer_fem_brecancer1)-window_size+1):nrow(Cancer_fem_brecancer1),]$ASR_scaled%>%as.matrix()),window_size,1)  
  } else if (x<=window_size){
    test_dataset <- cancer_ts_eval_dataset(rbind(Cancer_fem_brecancer1[(nrow(Cancer_fem_brecancer1)-window_size+x):nrow(Cancer_fem_brecancer1),]$ASR_scaled%>%as.matrix(),matrix(predict_20[1:(x-1)],ncol = 1)),window_size,1)  
  }
  else{
    test_dataset<-cancer_ts_eval_dataset(matrix(tail(predict_20,n=window_size),ncol=1),window_size,1)
  }
  
  test_dl<-test_dataset%>%dataloader(batch_size = 1)
  predict_20<-rbind(predict_20,as_array(fitted%>%predict(test_dl))[1])
}
```

###### 

```{r}
# Plot using ggplot2
predicted_df <- data.frame(Year = tail(Cancer_fem_brecancer1$Year,length(test_data_hat)), ASR_WHO = test_data_hat*original_sd+original_mu)


period<-20
predict_20 <- c()
for (x in 1:period){
  if (x==1){
    test_dataset <- cancer_ts_eval_dataset((Cancer_fem_brecancer1[(nrow(Cancer_fem_brecancer1)-window_size+1):nrow(Cancer_fem_brecancer1),]$ASR_scaled%>%as.matrix()),window_size,1)  
  } else if (x<=window_size){
    test_dataset <- cancer_ts_eval_dataset(rbind(Cancer_fem_brecancer1[(nrow(Cancer_fem_brecancer1)-window_size+x):nrow(Cancer_fem_brecancer1),]$ASR_scaled%>%as.matrix(),matrix(predict_20[1:(x-1)],ncol = 1)),window_size,1)  
  }
  else{
    test_dataset<-cancer_ts_eval_dataset(matrix(tail(predict_20,n=window_size),ncol=1),window_size,1)
  }
  
  test_dl<-test_dataset%>%dataloader(batch_size = 1)
  predict_20<-rbind(predict_20,as_array(fitted%>%predict(test_dl))[1])
}
```

```{r}
predicted_20_df <- data.frame(Year = c(2020:2039), ASR_WHO = predict_20*original_sd+original_mu)


##############################
ggplot() +
  geom_line(data = Cancer_fem_brecancer1, aes(x = Year, y = `Age-standardised rate (WHO) (per 100,000)`, color = "Actual"), linetype = "solid") +
  geom_line(data = predicted_df, aes(x = Year, y = ASR_WHO, color = "Predicted_test", linetype = "Predicted_test"), linetype = "dashed") +
  geom_line(data = predicted_20_df, aes(x = Year, y = ASR_WHO, color = "Predicted_20", linetype = "Predicted_20"), linetype = "dashed") +
  scale_color_manual(name = "Time Series", values = c("Actual" = "blue", "Predicted_test" = "red","Predicted_20"="orange")) +
  scale_linetype_manual(name = "Time Series", values = c("Actual" = "solid", "Predicted_test" = "dashed","Predicted_20"="dashed")) +
  labs(x = "Year", y = "Female Breast Cancer ASR", title = "Actual vs Predicted Time Series") +
  theme_minimal()

```

##### 1.2.2 ARIMA

```{r}
female_breast = ts(Cancer_fem_brecancer1$`Age-standardised rate (WHO) (per 100,000)`, start = 2001, freq = 1)
year_female_breast = seq(2001,2019)

```

###### 1.2.2.1 Data Exploration

```{r}
autoplot(female_breast) +
  xlab("Year") + ylab("Female Breast Cancer ASR")
```

###### 1.2.2.2 Examine stationarity

ADF test Augmented Dickey--Fuller Test can prove non-stationarity of female_cancer

H0: non-stationary

H1: stationary

```{r}
print(adf.test(female_breast))
```

p-value = 0.52 \>0.05 Do not reject null hypothesis. There are unit roots! roots outside unit circle

```{r}
autoplot(diff(female_breast)) +
  xlab("Year") + ylab("Order 1 Differenced Female Breast Cancer ASR")
par(mfcol=c(1,2))
ggAcf(diff(female_breast))
ggPacf(diff(female_breast))
```

```{r}
print(adf.test(diff(female_breast)))
```

```{r}
auto.arima(female_breast,max.P=0,max.Q=0,ic="aic")
auto.arima(female_breast,max.P=0,max.Q=0,ic="bic")
```

```{r}
fit_010 <- Arima(female_breast,order=c(0,1,0))
print(fit_010)
# plot in terminal
#tsdiag(fit_010)
```

```{r}
autoplot(diff(diff(female_breast))) +
  xlab("Year") + ylab("Order 2 Differenced Female Breast Cancer ASR")
par(mfcol=c(1,2))
ggAcf(diff(diff(female_breast)))
ggPacf(diff(diff(female_breast)))

print(adf.test(diff(diff(female_breast))))
```

ADF test proves that d = 2 differeenced ts is indeed stationary

###### 1.2.2.3 Model Selection (AIC & BIC)

Propose 3 models ARIMA(2,2,0) ARIMA(0,2,2) ARIMA(2,2,2)

```{r}
fit_220 <- Arima(female_breast,order=c(2,2,0))
fit_022 <- Arima(female_breast,order=c(0,2,2))
fit_222 <- Arima(female_breast,order=c(2,2,2))

print(fit_220)
print(fit_022)
print(fit_222)
```

```{r}
# Box test of residuals suggest that all proposed order 2 ARIMA conform to the assumption that the error term is a white noise with no correlation to each other
# tsdiag(fit_220)
# tsdiag(fit_022)
# tsdiag(fit_222)
```

Comapre 3 proposed model with model proposed by auto.arima

```{r}
# Create a tibble with model names and the models themselves
models <- tibble(
  model = c("fit_010", "fit_022", "fit_220", "fit_222"),
  arima_model = list(fit_010, fit_022, fit_220, fit_222)
)

# Use purrr::map_df to iterate over the models, extract AIC and BIC, and combine into a data frame
aic_bic <- models %>%
  mutate(
    aic = map_dbl(arima_model, AIC),
    bic = map_dbl(arima_model, BIC)
  ) %>%
  select(model, aic, bic)

# Arrange the rows based on AIC in descending order
aic_bic %>% arrange(aic)
```

```{r}
# brute force grid search

# Create an empty data frame to store results
results <- data.frame(p = numeric(),
                      d = numeric(),
                      q = numeric(),
                      aic = numeric(),
                      bic = numeric())

# Define parameter sets
p_values <- 0:4
d_values <- 1:3
q_values <- 0:4

# Perform grid search
for (p in p_values) {
  for (d in d_values) {
    for (q in q_values) {
      # Fit ARIMA model
      model <- tryCatch({
        fit <- Arima(female_breast, order = c(p, d, q), seasonal = list(order = c(0, 0, 0)),include.drift = TRUE)
        list(p = p, d = d, q = q, aic = AIC(fit), bic = BIC(fit))
      }, error = function(e) {
        NA  # If model fitting fails, return NA
      })
      
      # Append results to data frame
      if (!is.na(model$aic)) {
        results <- bind_rows(results, model)
      }
    }
  }
}

# Tabulate the results and order by AIC
results <- results %>%
  arrange(aic)

# Print the results
print(results)


```

###### 1.2.2.4 Visualization of prediction

```{r}
# Create forecasts for each model
forecast_010 <- forecast(fit_010, h = 20)
forecast_220 <- forecast(fit_220, h = 20)
forecast_022 <- forecast(fit_022, h = 20)
forecast_222 <- forecast(fit_222, h = 20)



# LSTM from 1.2.1
predicted_20_ts <- ts(predicted_20_df[,2],start=2020)



# Extract forecasted values from ARIMA models
forecast_010_values <- as.numeric(forecast_010$mean)
forecast_220_values <- as.numeric(forecast_220$mean)
forecast_022_values <- as.numeric(forecast_022$mean)
forecast_222_values <- as.numeric(forecast_222$mean)

# Combine forecasted values with LSTM predictions
all_forecasts <- data.frame(
  Year = seq(2001, 2039),
  Actual = c(as.numeric(unlist(Cancer_fem_brecancer1[,2])),rep(NA, 20)),  # Actual data from 2001 to 2019
  ARIMA_010 = c(rep(NA, 19), forecast_010_values),
  ARIMA_220 = c(rep(NA, 19), forecast_220_values),
  ARIMA_022 = c(rep(NA, 19), forecast_022_values),
  ARIMA_222 = c(rep(NA, 19), forecast_222_values),
  LSTM = c(rep(NA, 19), predicted_20_df[, 2])
)

# Reshape data into long format
all_forecasts_long <- tidyr::pivot_longer(
  all_forecasts, 
  cols = -Year, 
  names_to = "Model", 
  values_to = "Predicted_ASIR"
)

# Plot all forecasts using geom_line
ggplot(all_forecasts_long, aes(x = Year, y = Predicted_ASIR, color = Model, linetype = Model)) +
  geom_line(size=0.5) +
  #geom_line(data = all_forecasts, aes(x = Year, y = Actual), color = "black", linetype = "solid") +  # Add actual data
  labs(title = "Actual & Forecasted Female Breast Cancer ASR (1982-2039)",
       x = "Year",
       y = "Female Breast Cancer ASR",
       color = "Model",
       linetype = "Model") +
  scale_color_manual(values = c("black","red", "blue", "green", "cyan", "orange")) +
  scale_linetype_manual(values = c("solid","solid", "solid", "solid", "solid", "solid")) +
  theme_minimal()
```

###### 1.2.2.5 Comparison of LSTM WITH ARIMA (test loss)

```{r}
train_set_arima <- subset(female_breast,end=length(female_breast)-length(test_data))
test_set_arima <- subset(female_breast,start=length(female_breast)-length(test_data)+1)

```

```{r}
# Function to fit ARIMA model and compute MSE
fit_arima <- function(p, d, q, train_set, test_set) {
  # Fit ARIMA model
  fitted_arima <- Arima(train_set, order = c(p, d, q), seasonal = list(order = c(0, 0, 0)))
  
  # Compute forecast
  forecast_test_arima <- forecast(fitted_arima, h = length(test_set))$mean
  
  # Compute MSE
  mse <- sum((forecast_test_arima - test_set)^2) / length(test_set)
  
  return(list(p = p, d = d, q = q, mse = mse))
}

# Define parameter sets
p_values <- 0:4
d_values <- 1:3
q_values <- 0:4

# Create an empty data frame to store results
results <- data.frame(p = numeric(),
                      d = numeric(),
                      q = numeric(),
                      mse = numeric())

# Perform grid search
for (p in p_values) {
  for (d in d_values) {
    for (q in q_values) {
      # Fit ARIMA model and compute MSE
      model <- fit_arima(p, d, q, train_set_arima, test_set_arima)
      
      # Append results to data frame
      results <- bind_rows(results, model)
    }
  }
}

# Tabulate the results and order by MSE
results <- results %>%
  arrange(mse)

# Print the results
print(results)
cat("lstm_mse_loss",as_array(nn_mse_loss()
                             ((torch_tensor(test_data_hat)),(torch_tensor(test_data)))),"\n")

```

Based on grid search on mse loss, arima(2,1,0), arima(2,1,1), arima(1,1,2) are chosen as their test loss are minimum although still larger than loss of LSTM

```{r}
# It has been found that arima(0,1,0) is the best fit for train_set_arima(in terms of aic and bic)

fitted_arima010 <-  Arima(train_set_arima,order=c(0,1,0))
fitted_arima210 <-  Arima(train_set_arima,order=c(2,1,0))
fitted_arima211 <-  Arima(train_set_arima,order=c(2,1,1))
fitted_arima112 <-  Arima(train_set_arima,order=c(1,1,2))

forecast_test_arima010 <- as.numeric(forecast(fitted_arima010,h=length(test_data))$mean)
forecast_test_arima210 <- as.numeric(forecast(fitted_arima210,h=length(test_data))$mean)
forecast_test_arima211 <- as.numeric(forecast(fitted_arima211,h=length(test_data))$mean)
forecast_test_arima112 <- as.numeric(forecast(fitted_arima112,h=length(test_data))$mean)

# Combine forecasted values with LSTM predictions
train_forecasts <- data.frame(
  Year = seq(2001, 2019),
  Actual = as.numeric(unlist(Cancer_fem_brecancer1[,2])),  # Actual data from 2001 to 2019
  ARIMA_010 = c(rep(NA, length(female_breast)-length(test_data)),forecast_test_arima010),
  ARIMA_210 = c(rep(NA, length(female_breast)-length(test_data)),forecast_test_arima210),
  ARIMA_211 = c(rep(NA, length(female_breast)-length(test_data)),forecast_test_arima211),
  ARIMA_112 = c(rep(NA, length(female_breast)-length(test_data)),forecast_test_arima112),
  LSTM = c(rep(NA, length(female_breast)-length(test_data)),as.numeric(unlist(predicted_df[, 2])))
)

# Reshape data into long format
train_forecasts_long <- tidyr::pivot_longer(
  train_forecasts, 
  cols = -Year, 
  names_to = "Model", 
  values_to = "Predicted_ASIR"
)

# Plot all forecasts using geom_line
ggplot(train_forecasts_long, aes(x = Year, y = Predicted_ASIR, color = Model, linetype = Model)) +
  geom_line(size=0.5) +
  #geom_line(data = all_forecasts, aes(x = Year, y = Actual), color = "black", linetype = "solid") +  # Add actual data
  labs(title = "Actual & Forecasted Female Breast Cancer ASR (2001-2019)",
       x = "Year",
       y = "Female Breast Cancer ASR",
       color = "Model",
       linetype = "Model") +
  scale_color_manual(values = c("black","red", "blue","violet","gold","darkgreen")) +
  scale_linetype_manual(values = c("solid","dashed", "dashed","dashed","dashed","dashed")) +
  theme_minimal()


```

###### 

```{r}

# Create forecasts for each model
forecast_010 <- forecast(fitted_arima010, h = 20)
forecast_210 <- forecast(fitted_arima210, h = 20)
forecast_211 <- forecast(fitted_arima211, h = 20)
forecast_112 <- forecast(fitted_arima112, h = 20)



# LSTM from 1.2.1
predicted_20_ts <- ts(predicted_20_df[,2],start=2020)



# Extract forecasted values from ARIMA models
forecast_010_values <- as.numeric(forecast_010$mean)
forecast_210_values <- as.numeric(forecast_210$mean)
forecast_211_values <- as.numeric(forecast_211$mean)
forecast_112_values <- as.numeric(forecast_112$mean)

# Combine forecasted values with LSTM predictions
all_forecasts <- data.frame(
  Year = seq(2001, 2039),
  Actual = c(as.numeric(unlist(Cancer_fem_brecancer1[,2])),rep(NA, 20)),  # Actual data from 2001 to 2019
  ARIMA_010 = c(rep(NA, 19), forecast_010_values),
  ARIMA_210 = c(rep(NA, 19), forecast_210_values),
  ARIMA_211 = c(rep(NA, 19), forecast_211_values),
  ARIMA_112 = c(rep(NA, 19), forecast_112_values),
  LSTM = c(rep(NA, 19), predicted_20_df[, 2])
)

# Reshape data into long format
all_forecasts_long <- tidyr::pivot_longer(
  all_forecasts, 
  cols = -Year, 
  names_to = "Model", 
  values_to = "Predicted_ASIR"
)

# Plot all forecasts using geom_line
ggplot(all_forecasts_long, aes(x = Year, y = Predicted_ASIR, color = Model, linetype = Model)) +
  geom_line(size=0.5) +
  #geom_line(data = all_forecasts, aes(x = Year, y = Actual), color = "black", linetype = "solid") +  # Add actual data
  labs(title = "Actual & Forecasted Female Breast Cancer ASR (2001-2039)",
       x = "Year",
       y = "Female Breast Cancer ASR",
       color = "Model",
       linetype = "Model") +
  scale_color_manual(values = c("black","red", "blue", "green", "cyan", "orange")) +
  scale_linetype_manual(values = c("solid","solid", "solid", "solid", "solid", "solid")) +
  theme_minimal()
```

##### Dummy

##### 1.2.3 ARIMAX

In this section, we will explore ARIMA models with external variables for female breast cancers. The external variables(risk factors) we adopt are from Part (b) section 3

```{r}
glimpse(breast_data)
```

From Part (b) section 3, low_physical activity, tobacoo, drug_use and high body bmi are identified as strong risk factors.

```{r}
female_physical = ts(as.numeric(breast_data$Low_physical_activity), start = 2001, freq = 1)

female_tobacco = ts(as.numeric(breast_data$Tobacoo), start = 2001, freq = 1)

female_drug = ts(as.numeric(breast_data$Drug_use), start = 2001, freq = 1)

female_bmi = ts(as.numeric(breast_data$High_bodymass_index), start = 2001, freq = 1)
```

```{r}
autoplot(female_physical) +
  xlab("Year") + ylab("Female physical activities")

autoplot(female_tobacco) +
  xlab("Year") + ylab("Female tobacco usage")

autoplot(female_drug) +
  xlab("Year") + ylab("Female drug usage")

autoplot(female_bmi) +
  xlab("Year") + ylab("Female bmi index")
```

```{r}
# Combine external variables into a single matrix
#external_variables <- cbind(female_physical, female_tobacco, female_drug, female_bmi)
external_variables <- cbind(female_drug,female_tobacco, female_bmi,female_physical)
# Perform ARIMAX modeling using auto.arima
arimax_model <- auto.arima(female_breast, xreg = external_variables)

# Print model summary
summary(arimax_model)

```

###### 1.2.3.1 Model Selection (AIC & BIC)

```{r}
# brute force grid search

# Define range for p, d, q parameters
p_values <- 0:5
d_values <- 0:3  # Modify range for d values
q_values <- 0:5

# Initialize data frame to store results
results <- data.frame(p = integer(), d = integer(), q = integer(), AIC = numeric(), BIC = numeric())

# Loop through all combinations of p, d, q values
for (p in p_values) {
  for (d in d_values) {
    for (q in q_values) {
      # Fit ARIMAX model
      arimax_model <- Arima(female_breast, order=c(p, d, q), xreg = external_variables)
      
      # Store AIC and BIC values
      aic <- AIC(arimax_model)
      bic <- BIC(arimax_model)
      
      # Add results to data frame
      results <- bind_rows(results, data.frame(p = p, d = d, q = q, AIC = aic, BIC = bic))
    }
  }
}

# Tabulate results and order by AIC ascending
results_table <- results %>% arrange(AIC)

# Print results table
print(results_table)
```

Time Series Analysis for external variables as they are needed when forecasting target varaible female_breast

```{r}
arima_female_physical<-auto.arima(female_physical)
summary(arima_female_physical)
```

```{r}
arima_female_tobacco<-auto.arima(female_tobacco)
summary(arima_female_tobacco)
```

```{r}
arima_female_drug<-auto.arima(female_drug)
summary(arima_female_drug)
```

```{r}
arima_female_bmi<-auto.arima(female_bmi)
summary(arima_female_bmi)
```

```         
```

```{r}
# Create forecasts for each risk factors
# Define the external variables time series for the forecast horizon (2020-2039)
# female_drug,female_tobacco, female_bmi,female_physical
external_variables_forecast <- data.frame(
  Year = seq(2020, 2039),
  Female_Drug = as.numeric (forecast(arima_female_drug,h=20)$mean), # Forecasted values for female BMI from ARIMA model
  Female_Tobacco = as.numeric(forecast(arima_female_tobacco,h=20)$mean), # Forecasted values for female drug use from ARIMA model
  Female_Bmi = as.numeric(forecast(arima_female_bmi,h=20)$mean), # Forecasted values for female physical activity from ARIMA model
  Female_Physical = as.numeric(forecast(arima_female_physical,h=20)$mean) # Forecasted values for female tobacco use from ARIMA model
)
external_variables_forecast
```

```{r}
arimax_000 <- auto.arima(female_breast,xreg = external_variables)

arimax_534 <- Arima(female_breast, order=c(5, 3, 4), xreg = external_variables)

arimax_503 <- Arima(female_breast, order=c(5, 0, 3), xreg = external_variables)

arimax_304 <- Arima(female_breast, order=c(3, 0, 4), xreg = external_variables)



# Create forecasts for each model
forecast_000 <- forecast(arimax_000,xreg = ts(external_variables_forecast[,2:5],start=2020,frequency = 1), h = 20)
forecast_304 <- forecast(arimax_304,xreg = ts(external_variables_forecast[,2:5],start=2020,frequency = 1), h = 20)
forecast_534 <- forecast(arimax_534,xreg = ts(external_variables_forecast[,2:5],start=2020,frequency = 1), h = 20)
forecast_503 <- forecast(arimax_503,xreg =ts(external_variables_forecast[,2:5],start=2020,frequency = 1), h = 20)



# LSTM from 1.2.1
predicted_20_ts <- ts(predicted_20_df[,2],start=2020)



# Extract forecasted values from ARIMAX models
forecast_000_values <- as.numeric(forecast_000$mean)
forecast_304_values <- as.numeric(forecast_304$mean)
forecast_534_values <- as.numeric(forecast_534$mean)
forecast_503_values <- as.numeric(forecast_503$mean)

# Combine forecasted values with LSTM predictions
all_forecasts <- data.frame(
  Year = seq(2001, 2039),
  Actual = c(as.numeric(unlist(Cancer_fem_brecancer1[,2])),rep(NA, 20)),  # Actual data from 2001 to 2019
  ARIMAX_000 = c(rep(NA, 19), forecast_000_values),
  ARIMAX_304 = c(rep(NA, 19), forecast_304_values),
  ARIMAX_534 = c(rep(NA, 19), forecast_534_values),
  ARIMAX_503 = c(rep(NA, 19), forecast_503_values),
  LSTM = c(rep(NA, 19), predicted_20_df[, 2])
)

# Reshape data into long format
all_forecasts_long <- tidyr::pivot_longer(
  all_forecasts, 
  cols = -Year, 
  names_to = "Model", 
  values_to = "Predicted_ASIR"
)

# Plot all forecasts using geom_line
ggplot(all_forecasts_long, aes(x = Year, y = Predicted_ASIR, color = Model, linetype = Model)) +
  geom_line(size=0.5) +
  #geom_line(data = all_forecasts, aes(x = Year, y = Actual), color = "black", linetype = "solid") +  # Add actual data
  labs(title = "Actual & Forecasted Female Breast Cancer ASR (2001-2039)",
       x = "Year",
       y = "Female Breast Cancer ASR",
       color = "Model",
       linetype = "Model") +
  scale_color_manual(values = c("black","red", "blue", "green", "cyan", "orange")) +
  scale_linetype_manual(values = c("solid","solid", "solid", "solid", "solid", "solid")) +
  theme_minimal()
```

###### 1.2.3.2 Comparison of LSTM WITH ARIMAX(test loss)

Specify the best ts models for 4 risk factors first

-   Physical activity

-   Tobacco

-   BMI

-   Drug

```{r}
# physical activity
train_physical <- subset(female_physical,end=length(female_breast)-length(test_data))
test_physical <- subset(female_physical,start=length(female_breast)-length(test_data)+1)

# Function to fit ARIMA model and compute MSE
fit_arima <- function(p, d, q, train_set, test_set) {
  # Fit ARIMA model
  fitted_arima <- Arima(train_set, order = c(p, d, q), seasonal = list(order = c(0, 0, 0)))
  
  # Compute forecast
  forecast_test_arima <- forecast(fitted_arima, h = length(test_set))$mean
  
  # Compute MSE
  mse <- sum((forecast_test_arima - test_set)^2) / length(test_set)
  
  return(list(p = p, d = d, q = q, mse = mse))
}

# Define parameter sets
p_values <- 0:4
d_values <- 1:3
q_values <- 0:4

# Create an empty data frame to store results
results <- data.frame(p = numeric(),
                      d = numeric(),
                      q = numeric(),
                      mse = numeric())

# Perform grid search
for (p in p_values) {
  for (d in d_values) {
    for (q in q_values) {
      # Fit ARIMA model and compute MSE
      model <- fit_arima(p, d, q, train_physical, test_physical)
      
      # Append results to data frame
      results <- bind_rows(results, model)
    }
  }
}

# Tabulate the results and order by MSE
results <- results %>%
  arrange(mse)

# Print the results
print(results)

```

```{r}
phyiscal_arima010 <-  Arima(train_physical,order=c(0,1,0))

forecast_phyiscal_arima010 <- as.numeric(forecast(phyiscal_arima010,h=length(test_data))$mean)

# Combine forecasted values with LSTM predictions
train_forecasts <- data.frame(
  Year = seq(2001, 2019),
  # Actual = as.numeric(unlist(Cancer_fem_brecancer1[,2])),  # Actual data from 2001 to 2019
  Actual = female_physical, 
  ARIMA_010 = c(rep(NA, length(female_breast)-length(test_data)),forecast_phyiscal_arima010)
)

# Reshape data into long format
train_forecasts_long <- tidyr::pivot_longer(
  train_forecasts, 
  cols = -Year, 
  names_to = "Model", 
  values_to = "Predicted_ASIR"
)

# Plot all forecasts using geom_line
ggplot(train_forecasts_long, aes(x = Year, y = Predicted_ASIR, color = Model, linetype = Model)) +
  geom_line(size=0.5) +
  #geom_line(data = all_forecasts, aes(x = Year, y = Actual), color = "black", linetype = "solid") +  # Add actual data
  labs(title = "Actual & Forecasted Female Physical Activity (2001-2019)",
       x = "Year",
       y = "Physcial Activity",
       color = "Model",
       linetype = "Model") +
  scale_color_manual(values = c("black","red")) +
  scale_linetype_manual(values = c("solid","dashed")) +
  theme_minimal()
```

```{r}
# tobacco
train_tobacco <- subset(female_tobacco,end=length(female_breast)-length(test_data))
test_tobacco <- subset(female_tobacco,start=length(female_breast)-length(test_data)+1)

# Function to fit ARIMA model and compute MSE
fit_arima <- function(p, d, q, train_set, test_set) {
  # Fit ARIMA model
  fitted_arima <- Arima(train_set, order = c(p, d, q), seasonal = list(order = c(0, 0, 0)))
  
  # Compute forecast
  forecast_test_arima <- forecast(fitted_arima, h = length(test_set))$mean
  
  # Compute MSE
  mse <- sum((forecast_test_arima - test_set)^2) / length(test_set)
  
  return(list(p = p, d = d, q = q, mse = mse))
}

# Define parameter sets
p_values <- 0:2
d_values <- 0:3
q_values <- 0:2

# Create an empty data frame to store results
results <- data.frame(p = numeric(),
                      d = numeric(),
                      q = numeric(),
                      mse = numeric())

# Perform grid search
for (p in p_values) {
  for (d in d_values) {
    for (q in q_values) {
      # Fit ARIMA model and compute MSE
      model <- fit_arima(p, d, q, train_tobacco, test_tobacco)
      
      # Append results to data frame
      results <- bind_rows(results, model)
    }
  }
}

# Tabulate the results and order by MSE
results <- results %>%
  arrange(mse)

# Print the results
print(results)
```

```{r}
tobacco_arima232 <-  Arima(train_tobacco,order=c(2,3,2))

forecast_tobacco_arima232 <- as.numeric(forecast(tobacco_arima232,h=length(test_data))$mean)

# Combine forecasted values with LSTM predictions
train_forecasts <- data.frame(
  Year = seq(2001, 2019),
  # Actual = as.numeric(unlist(Cancer_fem_brecancer1[,2])),  # Actual data from 2001 to 2019
  Actual = female_tobacco, 
  ARIMA_232 = c(rep(NA, length(female_breast)-length(test_data)),forecast_tobacco_arima232)
)

# Reshape data into long format
train_forecasts_long <- tidyr::pivot_longer(
  train_forecasts, 
  cols = -Year, 
  names_to = "Model", 
  values_to = "Predicted_ASIR"
)

# Plot all forecasts using geom_line
ggplot(train_forecasts_long, aes(x = Year, y = Predicted_ASIR, color = Model, linetype = Model)) +
  geom_line(size=0.5) +
  #geom_line(data = all_forecasts, aes(x = Year, y = Actual), color = "black", linetype = "solid") +  # Add actual data
  labs(title = "Actual & Forecasted Female Tobacco Usage (2001-2019)",
       x = "Year",
       y = "Tobacco Usage",
       color = "Model",
       linetype = "Model") +
  scale_color_manual(values = c("black","red")) +
  scale_linetype_manual(values = c("solid","dashed")) +
  theme_minimal()
```

```         
```

```{r}
# drug
train_drug <- subset(female_drug,end=length(female_breast)-length(test_data))
test_drug <- subset(female_drug,start=length(female_breast)-length(test_data)+1)

# Function to fit ARIMA model and compute MSE
fit_arima <- function(p, d, q, train_set, test_set) {
  # Fit ARIMA model
  fitted_arima <- Arima(train_set, order = c(p, d, q), seasonal = list(order = c(0, 0, 0)))
  
  # Compute forecast
  forecast_test_arima <- forecast(fitted_arima, h = length(test_set))$mean
  
  # Compute MSE
  mse <- sum((forecast_test_arima - test_set)^2) / length(test_set)
  
  return(list(p = p, d = d, q = q, mse = mse))
}

# Define parameter sets
p_values <- 0:3
d_values <- 1:3
q_values <- 0:3

# Create an empty data frame to store results
results <- data.frame(p = numeric(),
                      d = numeric(),
                      q = numeric(),
                      mse = numeric())

# Perform grid search
for (p in p_values) {
  for (d in d_values) {
    for (q in q_values) {
      # Fit ARIMA model and compute MSE
      model <- fit_arima(p, d, q, train_drug, test_drug)
      
      # Append results to data frame
      results <- bind_rows(results, model)
    }
  }
}

# Tabulate the results and order by MSE
results <- results %>%
  arrange(mse)

# Print the results
print(results)

```

```{r}
drug_arima323 <-  Arima(train_drug,order=c(3,2,3))

forecast_drug_arima323 <- as.numeric(forecast(drug_arima323,h=length(test_data))$mean)

# Combine forecasted values with LSTM predictions
train_forecasts <- data.frame(
  Year = seq(2001, 2019),
  # Actual = as.numeric(unlist(Cancer_fem_brecancer1[,2])),  # Actual data from 2001 to 2019
  Actual = female_drug, 
  ARIMA_323 = c(rep(NA, length(female_breast)-length(test_data)),forecast_drug_arima323)
)

# Reshape data into long format
train_forecasts_long <- tidyr::pivot_longer(
  train_forecasts, 
  cols = -Year, 
  names_to = "Model", 
  values_to = "Predicted_ASIR"
)

# Plot all forecasts using geom_line
ggplot(train_forecasts_long, aes(x = Year, y = Predicted_ASIR, color = Model, linetype = Model)) +
  geom_line(size=0.5) +
  #geom_line(data = all_forecasts, aes(x = Year, y = Actual), color = "black", linetype = "solid") +  # Add actual data
  labs(title = "Actual & Forecasted Female Drug Usage (2001-2019)",
       x = "Year",
       y = "Drug Usage",
       color = "Model",
       linetype = "Model") +
  scale_color_manual(values = c("black","red")) +
  scale_linetype_manual(values = c("solid","dashed")) +
  theme_minimal()
```

```{r}
# physical activity
train_bmi <- subset(female_bmi,end=length(female_breast)-length(test_data))
test_bmi <- subset(female_bmi,start=length(female_breast)-length(test_data)+1)

# Function to fit ARIMA model and compute MSE
fit_arima <- function(p, d, q, train_set, test_set) {
  # Fit ARIMA model
  fitted_arima <- Arima(train_set, order = c(p, d, q), seasonal = list(order = c(0, 0, 0)))
  
  # Compute forecast
  forecast_test_arima <- forecast(fitted_arima, h = length(test_set))$mean
  
  # Compute MSE
  mse <- sum((forecast_test_arima - test_set)^2) / length(test_set)
  
  return(list(p = p, d = d, q = q, mse = mse))
}

# Define parameter sets
p_values <- 0:3
d_values <- 0:3
q_values <- 0:3

# Create an empty data frame to store results
results <- data.frame(p = numeric(),
                      d = numeric(),
                      q = numeric(),
                      mse = numeric())

# Perform grid search
for (p in p_values) {
  for (d in d_values) {
    for (q in q_values) {
      # Fit ARIMA model and compute MSE
      model <- fit_arima(p, d, q, train_bmi, test_bmi)
      
      # Append results to data frame
      results <- bind_rows(results, model)
    }
  }
}

# Tabulate the results and order by MSE
results <- results %>%
  arrange(mse)

# Print the results
print(results)

```

```{r}
bmi_arima323 <-  Arima(train_bmi,order=c(3,2,3))

forecast_bmi_arima323 <- as.numeric(forecast(bmi_arima323,h=length(test_data))$mean)

# Combine forecasted values with LSTM predictions
train_forecasts <- data.frame(
  Year = seq(2001, 2019),
  # Actual = as.numeric(unlist(Cancer_fem_brecancer1[,2])),  # Actual data from 2001 to 2019
  Actual = female_bmi, 
  ARIMA_323 = c(rep(NA, length(female_breast)-length(test_data)),forecast_bmi_arima323)
)

# Reshape data into long format
train_forecasts_long <- tidyr::pivot_longer(
  train_forecasts, 
  cols = -Year, 
  names_to = "Model", 
  values_to = "Predicted_ASIR"
)

# Plot all forecasts using geom_line
ggplot(train_forecasts_long, aes(x = Year, y = Predicted_ASIR, color = Model, linetype = Model)) +
  geom_line(size=0.5) +
  #geom_line(data = all_forecasts, aes(x = Year, y = Actual), color = "black", linetype = "solid") +  # Add actual data
  labs(title = "Actual & Forecasted Female BMI (2001-2019)",
       x = "Year",
       y = "BMI",
       color = "Model",
       linetype = "Model") +
  scale_color_manual(values = c("black","red")) +
  scale_linetype_manual(values = c("solid","dashed")) +
  theme_minimal()
```

```{r}

# Function to fit ARIMAX model and compute MSE
fit_arima <- function(p, d, q, train_set, test_set,ex_var_train,ex_var_test) {
  # Fit ARIMA model
  fitted_arima <- Arima(train_set, order = c(p, d, q),xreg = ex_var_train, seasonal = list(order = c(0, 0, 0)))
  
  # Compute forecast
  forecast_test_arima <- forecast(fitted_arima,xreg = as.matrix(ex_var_test) ,h = length(test_set))$mean
  
  # Compute MSE
  mse <- sum((forecast_test_arima - test_set)^2) / length(test_set)
  
  return(list(p = p, d = d, q = q, mse = mse))
}

ex_var_train <- cbind(female_drug[1:length(train_bmi)],female_tobacco[1:length(train_bmi)], female_bmi[1:length(train_bmi)],female_physical[1:length(train_bmi)])

ex_var_test <- data.frame(
  Female_Drug = as.numeric (forecast(drug_arima323,h=length(test_bmi))$mean), # Forecasted values for female BMI from ARIMA model
  Female_Tobacco = as.numeric(forecast(tobacco_arima232,h=length(test_bmi))$mean), # Forecasted values for female drug use from ARIMA model
  Female_Bmi = as.numeric(forecast(bmi_arima323,h=length(test_bmi))$mean), # Forecasted values for female physical activity from ARIMA model
  Female_Physical = as.numeric(forecast(phyiscal_arima010,h=length(test_bmi))$mean) # Forecasted values for female tobacco use from ARIMA model
)


# Define parameter sets
p_values <- 0:4
d_values <- 1:3
q_values <- 0:4

# Create an empty data frame to store results
results <- data.frame(p = numeric(),
                      d = numeric(),
                      q = numeric(),
                      mse = numeric())

# Perform grid searchex
for (p in p_values) {
  for (d in d_values) {
    for (q in q_values) {
      # Fit ARIMA model and compute MSE
      model <- fit_arima(p, d, q, train_set_arima, test_set_arima,ex_var_train,ex_var_test)
      
      # Append results to data frame
      results <- bind_rows(results, model)
    }
  }
}

# Tabulate the results and order by MSE
results <- results %>%
  arrange(mse)

# Print the results
print(results)
```

```{r}
# It has been found that arima(0,1,0) is the best fit for train_set_arima(in terms of aic and bic)


fitted_arima324 <-  Arima(train_set_arima,order=c(3,2,4),xreg=ex_var_train)

forecast_test_arima324 <- as.numeric(forecast(fitted_arima324,xreg=as.matrix(ex_var_test),h=length(test_data))$mean)

# Combine forecasted values with LSTM predictions
train_forecasts <- data.frame(
  Year = seq(2001, 2019),
  Actual = as.numeric(female_breast),  # Actual data from 2001 to 2019
  ARIMAX_324 = c(rep(NA, length(female_breast)-length(test_data)),forecast_test_arima324)
  )

# Reshape data into long format
train_forecasts_long <- tidyr::pivot_longer(
  train_forecasts, 
  cols = -Year, 
  names_to = "Model", 
  values_to = "Predicted_ASIR"
)

# Plot all forecasts using geom_line
ggplot(train_forecasts_long, aes(x = Year, y = Predicted_ASIR, color = Model, linetype = Model)) +
  geom_line(size=0.5) +
  #geom_line(data = all_forecasts, aes(x = Year, y = Actual), color = "black", linetype = "solid") +  # Add actual data
  labs(title = "Actual & Forecasted Female Breast Cancer ASR (2001-2019)",
       x = "Year",
       y = "Female Breast Cancer ASR",
       color = "Model",
       linetype = "Model") +
  scale_color_manual(values = c("black","red")) +
  scale_linetype_manual(values = c("solid","dashed")) +
  theme_minimal()

```

```{r}
arimax_534 <- Arima(female_breast, order=c(3, 2, 4), xreg = external_variables)

# final_physical_arima <- Arima(female_physical,order=c(0,1,0))
# final_tobacco_arima <-Arima(female_tobacco,order=c(2,3,2))
# final_bmi_arima <-auto.arima(female_bmi)
# final_drug_arima <-Arima(female_drug,order=c(3,2,3))

ex_var_20 <- data.frame(
  Female_Drug = as.numeric (forecast(drug_arima323,h=(20+length(test_data)))$mean), # Forecasted values for female BMI from ARIMA model
  Female_Tobacco = as.numeric(forecast(tobacco_arima232,h=(20+length(test_data)))$mean), # Forecasted values for female drug use from ARIMA model
  Female_Bmi = as.numeric(forecast(bmi_arima323,h=(20+length(test_data)))$mean), # Forecasted values for female physical activity from ARIMA model
  Female_Physical = as.numeric(forecast(phyiscal_arima010,h=(20+length(test_data)))$mean) # Forecasted values for female tobacco use from ARIMA model
)




# Create forecasts for each model
forecast_010 <- forecast(fitted_arima010, h = 20)
forecast_210 <- forecast(fitted_arima210, h = 20)
forecast_211 <- forecast(fitted_arima211, h = 20)
forecast_112 <- forecast(fitted_arima112, h = 20)
forecast_324 <- forecast(fitted_arima324,xreg = as.matrix(ex_var_20[(length(test_data)+1):(20+length(test_data)),]) , h=20)



# LSTM from 1.2.1
predicted_20_ts <- ts(predicted_20_df[,2],start=2020)



# Extract forecasted values from ARIMA models
forecast_010_values <- as.numeric(forecast_010$mean)
forecast_210_values <- as.numeric(forecast_210$mean)
forecast_211_values <- as.numeric(forecast_211$mean)
forecast_112_values <- as.numeric(forecast_112$mean)
forecast_324_values <- as.numeric(forecast_324$mean)

# Combine forecasted values with LSTM predictions
all_forecasts <- data.frame(
  Year = seq(2001, 2039),
  Actual = c(as.numeric(unlist(Cancer_fem_brecancer1[,2])),rep(NA, 20)),  # Actual data from 2001 to 2019
  ARIMA_010 = c(rep(NA, 19), forecast_010_values),
  ARIMA_210 = c(rep(NA, 19), forecast_210_values),
  ARIMA_211 = c(rep(NA, 19), forecast_211_values),
  ARIMA_112 = c(rep(NA, 19), forecast_112_values),
  ARIMAX_324 =c(rep(NA, 19), forecast_324_values),
  LSTM = c(rep(NA, 19), predicted_20_df[, 2])
)

# Reshape data into long format
all_forecasts_long <- tidyr::pivot_longer(
  all_forecasts, 
  cols = -Year, 
  names_to = "Model", 
  values_to = "Predicted_ASIR"
)

# Plot all forecasts using geom_line
ggplot(all_forecasts_long, aes(x = Year, y = Predicted_ASIR, color = Model, linetype = Model)) +
  geom_line(size=0.5) +
  #geom_line(data = all_forecasts, aes(x = Year, y = Actual), color = "black", linetype = "solid") +  # Add actual data
  labs(title = "Actual & Forecasted Female Breast Cancer ASR (2001-2039)",
       x = "Year",
       y = "Female Breast Cancer ASR",
       color = "Model",
       linetype = "Model") +
  scale_color_manual(values = c("black","red", "blue", "green", "cyan","violet", "orange")) +
  scale_linetype_manual(values = c("solid","solid","solid", "solid", "solid", "solid", "solid")) +
  theme_minimal()
```

```         
```
